<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FyreX Games V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('https://imcalledfyre.zya.me/sw.js')
    .then(() => console.log('Service worker registered'))
    .catch(e => console.error('SW registration failed:', e));
}
</script>


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'fyre-dark': '#0a0a1a',
                        'fyre-card': 'rgba(30, 30, 60, 0.4)',
                        'fyre-primary': '#6a00ff',
                        'fyre-secondary': '#ff00aa',
                    }
                }
            }
        }
    </script>

<style>
/* Base styles */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Inter', sans-serif; 
    background-color: #0a0a1a; 
    color: white; 
    overflow-y: auto; /* allow vertical scroll */
    overflow-x: hidden; /* prevent horizontal scroll */
}

/* Full-screen background setup */
#background-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
}

/* Modal styling */
#auth-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 10, 26, 0.95);
    z-index: 100;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Main content fade-in */
#main-content {
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    min-height: auto;
    display: block;
    padding-bottom: 50px;
}

/* Custom scrollbar for chat */
#chat-messages::-webkit-scrollbar { width: 6px; }
#chat-messages::-webkit-scrollbar-thumb { 
    background: #ff00aa; 
    border-radius: 3px; 
}
#chat-messages::-webkit-scrollbar-track { 
    background: rgba(255, 255, 255, 0.1); 
}

/* New styles for the game grid and tiles */
.game-tile {
    aspect-ratio: 1 / 1;
    background-size: cover;
    background-position: center;
    border-radius: 0.75rem; /* rounded-xl */
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 0.75rem; /* p-3 */
    overflow: hidden;
    position: relative;
    cursor: pointer;
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    border: 2px solid transparent;
}
.game-tile:hover:not(.banned-disabled) {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(106, 0, 255, 0.7);
    border-color: #6a00ff;
}
/* Banned tile style */
.game-tile.banned-disabled {
    cursor: not-allowed;
    opacity: 0.5;
    pointer-events: none; /* Disables click */
}

.game-tile::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 60%);
}
.game-tile-name {
    position: relative;
    z-index: 2;
    font-weight: 600; /* semibold */
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
}

/* Modal animations */
.animate-fade-in-up {
    animation: fadeInUp 0.3s ease-out forwards;
}
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}


/* Optional: scrollbar for whole page if needed */
::-webkit-scrollbar {
    width: 8px;
}
::-webkit-scrollbar-thumb {
    background: #6a00ff88;
    border-radius: 4px;
}
::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}
</style>

</head>
<body class="selection:bg-fyre-primary selection:text-white">

    <canvas id="background-canvas"></canvas>

    <div id="banned-overlay" class="hidden fixed inset-0 bg-red-900/95 flex items-center justify-center z-[500]">
        <div class="p-10 rounded-xl text-center border-4 border-red-500 shadow-2xl bg-red-900/80">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto text-red-400 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
            <h2 class="text-4xl font-extrabold text-red-300 mb-3">ACCOUNT BANNED</h2>
            <p class="text-xl text-red-200">This account has been permanently suspended.</p>
            <p class="text-md text-red-400 mt-2">You cannot launch games or use the chat.</p>
        </div>
    </div>
    <div id="auth-modal" class="hidden">
        <div class="bg-fyre-card border border-fyre-primary p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold text-fyre-primary mb-6 text-center" id="auth-title">Welcome to FyreX</h2>
            <p>ALL ACCOUNTS + DATA RESET. SIGN UP AGAIN</p>
            <form id="auth-form" onsubmit="handleAuth(event)">
                <div class="mb-4">
                    <label for="auth-username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                    <input type="text" id="auth-username" name="username" required 
                           class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:ring-fyre-secondary focus:border-fyre-secondary text-white transition duration-300">
                </div>
                <div class="mb-6">
                    <label for="auth-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="auth-password" name="password" required 
                           class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:ring-fyre-secondary focus:border-fyre-secondary text-white transition duration-300">
                </div>
                <button type="submit" id="auth-button"
                        class="w-full py-3 rounded-lg font-bold text-lg text-white transition duration-300 
                               bg-fyre-primary hover:bg-opacity-80 focus:outline-none focus:ring-4 focus:ring-fyre-primary/50">
                    Log In
                </button>
            </form>
            <p class="text-center text-sm mt-4">
                <span class="text-gray-400" id="auth-toggle-text">Don't have an account?</span>
                <button onclick="toggleAuthMode()" class="text-fyre-secondary hover:text-white font-semibold ml-1 transition duration-300">
                    Sign Up
                </button>
            </p>
            <p id="auth-message" class="text-center mt-4 text-sm font-medium text-red-400"></p>
        </div>
    </div>

    <div id="main-content" class="relative z-10 p-4 sm:p-8">
        
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 p-4 bg-fyre-card rounded-xl shadow-lg border border-fyre-primary/50">
            <h1 class="text-4xl font-extrabold text-fyre-secondary tracking-wider mb-4 sm:mb-0">FyreX Launcher <span class="text-sm font-light text-gray-400">V4</span></h1>
            <div class="flex items-center space-x-4">
                
                <div class="bg-fyre-secondary px-3 py-1 rounded-full text-sm font-bold flex items-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-yellow-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 00-1-1H9a1 1 0 000 2h1a1 1 0 110 2H9a1 1 0 100 2h2a1 1 0 100-2h-1a1 1 0 010-2h1a1 1 0 001-1z" clip-rule="evenodd" />
                    </svg>
                    <span id="fyre-coins-counter">---</span> <span class="ml-1 font-light text-xs">FC</span>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-400">Welcome,</p>
                    <p class="font-semibold text-white truncate max-w-[150px]" id="current-username">Guest</p>
                </div>
                <span class="bg-fyre-primary px-3 py-1 rounded-full text-xs font-bold" id="conn-status">Connecting to servers...</span>
                <button onclick="logout()" class="text-white hover:text-fyre-secondary transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold text-white mb-4">Game Library</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="game-search-input" placeholder="Search for a game..." class="flex-grow px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:ring-fyre-secondary focus:border-fyre-secondary text-white transition duration-300">
                    <select id="sort-order-select" onchange="renderGamesFromCache(document.getElementById('game-search-input').value, this.value)"
                            class="px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-fyre-secondary focus:border-fyre-secondary appearance-none cursor-pointer">
                        <option value="rating">Sort by: ★ Rating (Default)</option>
                        <option value="name">Sort by: Name (A-Z)</option>
                    </select>
                </div>

                <div id="game-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <div id="loading-game-msg" class="text-center text-gray-500 italic col-span-full">Loading game list...</div>
                </div>
            </div>

            <div>
                <div class="bg-fyre-card p-4 rounded-xl shadow-lg border border-fyre-secondary/50 mb-6">
                    <h3 class="text-xl font-bold text-fyre-secondary mb-2">Live Status</h3>
                    <p class="text-sm text-gray-300">Online Users: <span id="online-count" class="font-bold text-white">0</span></p>
                    <div id="dm-notification-area" class="mt-3 hidden p-3 bg-red-800/50 border border-red-500 rounded-lg">
                        <p class="font-semibold text-red-300">New DM!</p>
                        <p class="text-sm text-white truncate" id="dm-notification-content"></p>
                    </div>
                </div>

                <div class="bg-fyre-card p-4 rounded-xl shadow-2xl border border-fyre-primary/50 flex flex-col h-[400px]">
                    <h3 class="text-xl font-bold text-fyre-primary mb-3">Global Chat (Messages may take a few seconds to go through)</h3>
                    <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 mb-3 pr-2 text-sm">
                        <div id="loading-chat-msg" class="text-center text-gray-500 italic">Loading messages...</div>
                    </div>
                    <form id="chat-form" onsubmit="sendChatMessage(event)" class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Type your message..." required
                               class="flex-grow px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:ring-fyre-secondary focus:border-fyre-secondary text-white text-sm">
                        <button type="submit" id="chat-send-button"
                                class="bg-fyre-secondary px-4 py-2 rounded-lg text-white font-semibold hover:bg-fyre-secondary/80 transition duration-300">
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="game-details-modal" class="hidden fixed inset-0 bg-fyre-dark bg-opacity-90 flex items-center justify-center z-50 p-4">
        <div id="game-details-content" class="bg-fyre-card border border-fyre-primary p-6 rounded-xl shadow-2xl w-full max-w-2xl relative text-white animate-fade-in-up">
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const BACKEND_URL = 'https://backend.imcalledfyre.com';
        const GAMES_JSON_PATH = 'https://imcalledfyre.zya.me/games.json';
        
        let socket = null;
        let authMode = 'login';
        let authToken = localStorage.getItem('fyrexToken') || '';
        let authUsername = localStorage.getItem('fyrexUsername') || '';
        let userUUID = ''; 
        
        // NEW STATE VARIABLES
        let fyreCoins = 0;
        // Check local storage for persistent ban status on page load
        let isBanned = localStorage.getItem('fyrexBannedStatus') === 'true'; 
        
        let appDataCache = {
            ratings: {},
            messages: [],
            games: []
        };

        // --- NEW: UI Update Functions ---

        function updateFyreCoinsUI(coins) {
            fyreCoins = coins;
            document.getElementById('fyre-coins-counter').textContent = coins.toLocaleString();
        }

        function handleBanStatus(banned) {
            isBanned = banned;
            const overlay = document.getElementById('banned-overlay');
            const chatInput = document.getElementById('chat-input');
            const chatButton = document.getElementById('chat-send-button');
            const gameTiles = document.querySelectorAll('#game-list .game-tile');

            if (banned) {
                // Store ban status persistently so it survives refresh
                localStorage.setItem('fyrexBannedStatus', 'true');
                
                console.warn('User is BANNED! Disabling features.');
                overlay.classList.remove('hidden');
                // Ensure pointer-events are NOT none so the ban screen is a true block
                overlay.classList.remove('pointer-events-none'); 
                
                // Disable chat
                chatInput.disabled = true;
                chatInput.placeholder = "You are banned from using the chat.";
                chatButton.disabled = true;
                chatButton.textContent = 'Banned'; // Visual feedback on button

                // Disable game tiles (Visually and prevent clicks via class)
                gameTiles.forEach(tile => {
                    tile.classList.add('banned-disabled');
                    tile.removeAttribute('onclick');
                });
            } else {
                // Remove ban status on unban/logout
                localStorage.removeItem('fyrexBannedStatus');

                overlay.classList.add('hidden');
                overlay.classList.add('pointer-events-none'); // Re-add pointer-events-none when hidden

                // Enable chat
                chatInput.disabled = false;
                chatInput.placeholder = "Type your message...";
                chatButton.disabled = false;
                chatButton.textContent = 'Send';

                // Re-enable game tiles (Visually and restore click handler)
                gameTiles.forEach(tile => {
                    tile.classList.remove('banned-disabled');
                    const gameId = tile.dataset.gameId; 
                    if (gameId) {
                        tile.setAttribute('onclick', `showGameDetails('${gameId}')`);
                    }
                });
            }
        }

        // --- Authentication & Setup ---

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            document.getElementById('auth-title').textContent = authMode === 'login' ? 'Welcome to FyreX' : 'Create New Account';
            document.getElementById('auth-button').textContent = authMode === 'login' ? 'Log In' : 'Sign Up';
            document.getElementById('auth-toggle-text').textContent = authMode === 'login' ? "Don't have an account?" : "Already have an account?";
            document.getElementById('auth-message').textContent = '';
        }

        async function handleAuth(event) {
            event.preventDefault();
            const form = document.getElementById('auth-form');
            const messageElement = document.getElementById('auth-message');
            const data = {
                username: form.elements['username'].value,
                password: form.elements['password'].value
            };
            
            messageElement.textContent = 'Processing...';

            try {
                const endpoint = `${BACKEND_URL}/${authMode}`;
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Check for ban status on successful login
                    if (result.is_banned) {
                        messageElement.textContent = 'Login successful, but this account is banned.';
                        handleBanStatus(true); // Persist ban status
                        
                        // Still store token, but don't proceed to startApp fully
                        authToken = result.token;
                        authUsername = result.username;
                        localStorage.setItem('fyrexToken', authToken);
                        localStorage.setItem('fyrexUsername', authUsername);
                        
                        setTimeout(() => {
                            document.getElementById('auth-modal').style.display = 'none';
                            document.getElementById('main-content').style.opacity = '1';
                            document.getElementById('current-username').textContent = authUsername;
                            connectSocket(); // Connect to server to possibly receive unban/updates
                        }, 1000);

                    } else {
                        // Successful login for non-banned user
                        messageElement.textContent = result.message;
                        messageElement.classList.remove('text-red-400');
                        messageElement.classList.add('text-green-400');
                        
                        authToken = result.token;
                        authUsername = result.username;
                        localStorage.setItem('fyrexToken', authToken);
                        localStorage.setItem('fyrexUsername', authUsername);
                        
                        // Ensure ban status is cleared if they were previously banned locally
                        handleBanStatus(false);
                        
                        setTimeout(startApp, 1000); 
                    }
                } else {
                    messageElement.textContent = result.message;
                    messageElement.classList.remove('text-green-400');
                    messageElement.classList.add('text-red-400');
                }
            } catch (error) {
                console.error('Authentication Error:', error);
                messageElement.textContent = `Network error: Could not connect to the server.`;
                messageElement.classList.remove('text-green-400');
                messageElement.classList.add('text-red-400');
            }
        }
        
        function logout() {
            localStorage.removeItem('fyrexToken');
            localStorage.removeItem('fyrexUsername');
            // Clear persistent ban status on logout
            localStorage.removeItem('fyrexBannedStatus');
            authToken = '';
            authUsername = '';
            // Reset state
            updateFyreCoinsUI(0);
            handleBanStatus(false); 
            if (socket) {
                socket.disconnect();
            }
            window.location.reload(); 
        }

        // --- WebSocket Communication ---

        function connectSocket() {
            document.getElementById('conn-status').textContent = 'Connecting...';
            document.getElementById('conn-status').classList.remove('bg-green-500', 'bg-red-500');
            document.getElementById('conn-status').classList.add('bg-fyre-primary');

            socket = io(BACKEND_URL, {
                query: { token: authToken },
                transports: ['websocket'], 
                secure: true
            });

            socket.on('connect', () => {
                document.getElementById('conn-status').textContent = 'Connected';
                document.getElementById('conn-status').classList.remove('bg-fyre-primary', 'bg-red-500');
                document.getElementById('conn-status').classList.add('bg-green-500');
            });

            socket.on('disconnect', () => {
                document.getElementById('conn-status').textContent = 'Disconnected';
                document.getElementById('conn-status').classList.remove('bg-fyre-primary', 'bg-green-500');
                document.getElementById('conn-status').classList.add('bg-red-500');
            });
            
            socket.on('connect_error', (error) => {
                console.error("Socket connection failed:", error);
                document.getElementById('conn-status').textContent = 'Conn Error';
                document.getElementById('conn-status').classList.remove('bg-fyre-primary', 'bg-green-500');
                document.getElementById('conn-status').classList.add('bg-red-500');
            });
            
            // Server tells us we're banned and disconnected us
            socket.on('banned', (data) => {
                console.error("Received ban notification from server:", data.message);
                handleBanStatus(true); // Persist ban status
            });

            // --- Real-time Data Handlers ---
            
            socket.on('initial_data', (data) => {
                appDataCache.messages = data.messages || [];
                appDataCache.ratings = data.ratings || {};
                
                // Handle initial FyreCoins and ban status from server (overrides local state if needed)
                updateFyreCoinsUI(data.fyre_coins || 0);
                // Call handleBanStatus based on server status. This handles unbans as well.
                handleBanStatus(data.is_banned || false); 

                renderChatMessages();
                // When we get initial data, re-render games using the current search/sort settings
                const currentSearch = document.getElementById('game-search-input').value;
                const currentSort = document.getElementById('sort-order-select').value;
                renderGamesFromCache(currentSearch, currentSort); 
            });

            socket.on('new_message', (message) => {
                // System message check for coin updates
                if (message.username === 'System' && message.content.includes('FyreCoin balance is:')) {
                    const match = message.content.match(/(\d+)\s+FC/);
                    if (match) {
                        const newCoins = parseInt(match[1]);
                        updateFyreCoinsUI(newCoins);
                    }
                }
                
                appDataCache.messages.push(message);
                renderChatMessage(message);
            });
            
            socket.on('ratings_update', (ratings) => {
                appDataCache.ratings = ratings;
                // Use current search and sort settings when updating
                const currentSearch = document.getElementById('game-search-input').value;
                const currentSort = document.getElementById('sort-order-select').value;
                renderGamesFromCache(currentSearch, currentSort);
                
                // If the game details modal is open, update its rating display
                const modalContent = document.getElementById('game-details-content');
                const gameId = modalContent.dataset.gameId;
                if (gameId) {
                    const ratingContainer = modalContent.querySelector('#modal-rating-container');
                    if(ratingContainer) {
                         ratingContainer.innerHTML = ''; // Clear old rating
                         ratingContainer.appendChild(createStarRating(gameId)); // Add new rating
                    }
                }
            });
            
            socket.on('user_count_update', (data) => {
                document.getElementById('online-count').textContent = data.count;
            });

            socket.on('dm_notification', (data) => {
                const dmArea = document.getElementById('dm-notification-area');
                const dmContent = document.getElementById('dm-notification-content');

                dmContent.innerHTML = `<span class="font-semibold text-red-100">${data.sender}:</span> ${data.content}`;
                dmArea.classList.remove('hidden');
                
                setTimeout(() => {
                    dmArea.classList.add('hidden');
                }, 5000);
            });
        }

        // --- Chat Functions ---

        function formatTimestamp(ms) {
            const date = new Date(ms);
            return `[${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}]`;
        }

        function renderChatMessage(message) {
            const chatMessagesDiv = document.getElementById('chat-messages');
            const isSelf = message.username === authUsername;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;
            
            const hash = Array.from(message.username).reduce((s, c) => Math.imul(31, s) + c.charCodeAt(0) | 0, 0);
            const hue = hash % 360;
            const userColor = `hsl(${hue}, 80%, 70%)`;

            messageDiv.innerHTML = `
                <div class="${isSelf ? 'bg-fyre-secondary/60' : 'bg-gray-700/60'} max-w-xs p-2 rounded-xl shadow-md">
                    <p class="text-xs font-semibold" style="color:${userColor};">
                        ${message.username} <span class="text-gray-400 font-light">${formatTimestamp(message.timestamp)}</span>
                    </p>
                    <p class="text-sm break-words">${message.content}</p>
                </div>
            `;
            chatMessagesDiv.appendChild(messageDiv);
            
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function renderChatMessages() {
            const chatMessagesDiv = document.getElementById('chat-messages');
            chatMessagesDiv.innerHTML = ''; 

            if (appDataCache.messages.length === 0) {
                 chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500 italic">No messages yet. Say hi!</div>';
            } else {
                 appDataCache.messages.forEach(renderChatMessage);
            }
        }
        
        function sendChatMessage(event) {
            event.preventDefault();
            // Ban check
            if (isBanned) {
                renderChatMessage({ username: 'System', content: 'You are banned and cannot send messages.', timestamp: Date.now() });
                return;
            }

            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            
            if (content && socket && socket.connected) {
                socket.emit('send_message', { content });
                input.value = '';
            } else if (!socket || !socket.connected) {
                const errorMsg = {
                    username: 'System', 
                    content: 'You are disconnected. Please refresh or check the server.', 
                    timestamp: Date.now()
                };
                renderChatMessage(errorMsg);
            }
        }
        
        // --- Game Rating Functions ---
        
        function submitRating(gameId, rating) {
            if (isBanned) {
                renderChatMessage({ username: 'System', content: 'You are banned and cannot submit ratings.', timestamp: Date.now() });
                return;
            }
            if (socket && socket.connected) {
                socket.emit('submit_rating', { game_id: gameId, rating: rating });
            } else {
                const errorMsg = {
                    username: 'System', 
                    content: 'Cannot submit rating: Disconnected from server.', 
                    timestamp: Date.now()
                };
                renderChatMessage(errorMsg);
            }
        }
        
        function createStarRating(gameId) {
            const ratingData = appDataCache.ratings[gameId] || { average: 'N/A', count: 0, votes: {} };
            const average = ratingData.average === 'N/A' ? 0 : parseFloat(ratingData.average);
            
            // 1. Get user's existing vote (assuming authUsername is the key in ratingData.votes)
            const userVote = ratingData.votes[authUsername] || 0; 

            const container = document.createElement('div');
            // Use flex-col and space-y-2 for better structure of stars and info
            container.className = 'flex flex-col space-y-2'; 

            const starContainer = document.createElement('div');
            starContainer.className = 'flex items-center space-x-1 text-2xl';

            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                // Use a larger star for better clicking/hovering and more prominent display
                star.className = 'cursor-pointer text-3xl transition-transform duration-150 transform hover:scale-110';
                star.textContent = '★'; 
                star.dataset.ratingValue = i;
                
                // Color logic: Prioritize user's vote, then show community average
                if (i <= userVote) {
                    // User's own vote: use primary color
                    star.classList.add('text-fyre-primary'); 
                    star.classList.remove('text-yellow-400', 'text-gray-700');
                } else if (i <= average) {
                    // Community average: use a standard gold/yellow
                    star.classList.add('text-yellow-400');
                    star.classList.remove('text-fyre-primary', 'text-gray-700');
                } else {
                    // Unrated: dim gray
                    star.classList.add('text-gray-700');
                    star.classList.remove('text-fyre-primary', 'text-yellow-400');
                }

                // Add interactive hover effect via JS for immediate visual feedback
                star.onmouseover = function() {
                    if (isBanned) return;
                    // Highlight all stars up to and including this one with fyre-secondary
                    for (let j = 1; j <= 5; j++) {
                        const s = starContainer.children[j - 1];
                        if (j <= i) {
                            s.classList.add('text-fyre-secondary');
                            s.classList.remove('text-fyre-primary', 'text-yellow-400', 'text-gray-700');
                        } else {
                            // Reset stars beyond the hover to their original state (user vote or average)
                            if (j <= userVote) {
                                s.classList.add('text-fyre-primary');
                                s.classList.remove('text-fyre-secondary', 'text-yellow-400', 'text-gray-700');
                            } else if (j <= average) {
                                s.classList.add('text-yellow-400');
                                s.classList.remove('text-fyre-secondary', 'text-fyre-primary', 'text-gray-700');
                            } else {
                                s.classList.add('text-gray-700');
                                s.classList.remove('text-fyre-secondary', 'text-fyre-primary', 'text-yellow-400');
                            }
                        }
                    }
                };

                // Reset colors on mouse out
                star.onmouseout = function() {
                    // Reset all stars to their original state (user vote or average)
                    for (let j = 1; j <= 5; j++) {
                        const s = starContainer.children[j - 1];
                        if (j <= userVote) {
                            s.classList.add('text-fyre-primary');
                            s.classList.remove('text-fyre-secondary', 'text-yellow-400', 'text-gray-700');
                        } else if (j <= average) {
                            s.classList.add('text-yellow-400');
                            s.classList.remove('text-fyre-secondary', 'text-fyre-primary', 'text-gray-700');
                        } else {
                            s.classList.add('text-gray-700');
                            s.classList.remove('text-fyre-secondary', 'text-fyre-primary', 'text-yellow-400');
                        }
                    }
                };

                // Click handler to submit rating
                star.onclick = function() {
                    if (isBanned) return;
                    const newRating = parseInt(this.dataset.ratingValue);
                    // Optimistic UI update: change color immediately
                    for (let j = 1; j <= 5; j++) {
                        const s = starContainer.children[j-1];
                        if(j <= newRating) {
                            s.classList.add('text-fyre-primary'); // Set to user's vote color
                            s.classList.remove('text-fyre-secondary', 'text-yellow-400', 'text-gray-700');
                        } else {
                            s.classList.add('text-gray-700'); // Set un-voted stars to gray
                            s.classList.remove('text-fyre-secondary', 'text-fyre-primary', 'text-yellow-400');
                        }
                    }
                    submitRating(gameId, newRating);
                };

                starContainer.appendChild(star);
            }
            
            // Add the star container to the main container
            container.appendChild(starContainer);

            // 2. Create and add the info text
            const infoText = document.createElement('p');
            infoText.className = 'text-xs text-gray-400';
            const avgDisplay = (average === 0) ? 'N/A' : average.toFixed(1);
            infoText.textContent = `Avg: ${avgDisplay} / 5 (${ratingData.count} ${ratingData.count === 1 ? 'vote' : 'votes'})`;
            
            // Add a hint if the user has voted
            if (userVote > 0) {
                const userVoteText = document.createElement('span');
                userVoteText.className = 'ml-2 text-fyre-primary font-semibold';
                userVoteText.textContent = `(Your vote: ${userVote})`;
                infoText.appendChild(userVoteText);
            }
            
            container.appendChild(infoText);
            
            return container;
        }

        // --- Game List & Modal Functions ---

        async function fetchGames() {
            try {
                const response = await fetch(GAMES_JSON_PATH);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const games = await response.json();
                appDataCache.games = games;
                renderGamesFromCache('', 'rating'); // Initial render
            } catch (error) {
                console.error("Failed to load games.json:", error);
                document.getElementById('loading-game-msg').textContent = `Error loading game list. Please refresh.`;
                document.getElementById('loading-game-msg').classList.add('text-red-400');
            }
        }

        function renderGamesFromCache(searchTerm = '', sortOrder = 'rating') {
            const gameListDiv = document.getElementById('game-list');
            const loadingMsg = document.getElementById('loading-game-msg');
            
            // 1. Filter games
            const lowerSearchTerm = searchTerm.toLowerCase();
            const filteredGames = appDataCache.games.filter(game => 
                game.name.toLowerCase().includes(lowerSearchTerm)
            );

            // 2. Sort games
            filteredGames.sort((a, b) => {
                if (sortOrder === 'name') {
                    return a.name.localeCompare(b.name);
                } else { // Default to 'rating'
                    const ratingA = appDataCache.ratings[a.id]?.average || 0;
                    const ratingB = appDataCache.ratings[b.id]?.average || 0;
                    // Sort descending (highest rating first)
                    return parseFloat(ratingB) - parseFloat(ratingA);
                }
            });

            // 3. Render
            gameListDiv.innerHTML = ''; // Clear existing list
            
            if (filteredGames.length === 0) {
                loadingMsg.textContent = 'No games found.';
                gameListDiv.appendChild(loadingMsg);
            } else {
                loadingMsg.textContent = '';
                filteredGames.forEach(game => {
                    gameListDiv.appendChild(createGameTile(game));
                });
            }
        }

        function createGameTile(game) {
            const tile = document.createElement('div');
            tile.className = 'game-tile';
            // Prepend CDN URL
            tile.style.backgroundImage = `url('https://imcalledfyre.zya.me/${game.thumbnail.replace(/^\.?\//, '')}')`;
            tile.dataset.gameId = game.id; 

            // Add banned class if user is banned
            if (isBanned) {
                tile.classList.add('banned-disabled');
            } else {
                tile.setAttribute('onclick', `showGameDetails('${game.id}')`);
            }

            const name = document.createElement('span');
            name.className = 'game-tile-name';
            name.textContent = game.name;
            tile.appendChild(name);
            
            return tile;
        }

        function showGameDetails(gameId) {
            const game = appDataCache.games.find(g => g.id === gameId);
            if (!game) return;

            const modal = document.getElementById('game-details-modal');
            const contentDiv = document.getElementById('game-details-content');
            contentDiv.dataset.gameId = gameId; // Store gameId for rating updates

            // Build modal content
            contentDiv.innerHTML = `
                <button onclick="closeGameDetails()" class="absolute top-4 right-4 text-gray-500 hover:text-white transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <div class="flex flex-col sm:flex-row">
                    <img src="https://imcalledfyre.zya.me/${game.thumbnail.replace(/^\.?\//, '')}" alt="${game.name}" class="w-1/3 h-auto object-cover rounded-lg shadow-lg mr-6">
                    
                    <div class="flex-1 mt-4 sm:mt-0">
                        <h2 class="text-4xl font-extrabold text-white mb-2">${game.name}</h2>
                        <p class="text-gray-300 mb-4">${game.description}</p>
                        
                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-gray-400 mb-2">COMMUNITY RATING</h4>
                            <div id="modal-rating-container">
                                </div>
                        </div>

                        <a href="https://imcalledfyre.zya.me/${game.link.replace(/^\.?\//, '')}" target="_blank" id="launch-game-button" class="mt-6 inline-block bg-fyre-primary text-white text-lg font-bold px-8 py-3 rounded-lg shadow-lg hover:bg-opacity-80 transition duration-300 ${isBanned ? 'banned-disabled' : ''}">
                            ${isBanned ? 'Banned' : 'Launch Game'}
                        </a>
                        ${isBanned ? '<p class="text-red-400 text-sm mt-2">You are banned and cannot launch games.</p>' : ''}
                    </div>
                </div>
            `;
            
            // Inject the star rating
            const ratingContainer = contentDiv.querySelector('#modal-rating-container');
            ratingContainer.appendChild(createStarRating(gameId));

            modal.classList.remove('hidden');
        }

        function closeGameDetails() {
            const modal = document.getElementById('game-details-modal');
            modal.classList.add('hidden');
            const contentDiv = document.getElementById('game-details-content');
            contentDiv.innerHTML = ''; // Clear content
            contentDiv.dataset.gameId = ''; // Clear stored gameId
        }

        // --- App Initialization ---

        function startApp() {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('main-content').style.opacity = '1';
            document.getElementById('current-username').textContent = authUsername;
            
            // Apply ban status if it was stored in localStorage from a previous session
            if (isBanned) {
                handleBanStatus(true);
            }

            connectSocket();
            fetchGames();
            
            // Add search and sort listeners
            document.getElementById('game-search-input').addEventListener('input', (e) => {
                const sortOrder = document.getElementById('sort-order-select').value;
                renderGamesFromCache(e.target.value, sortOrder);
            });
        }

        // --- 3D Background ---
        function initBackground() {
            const canvas = document.getElementById('background-canvas');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const geometry = new THREE.BufferGeometry();
            const particles = 5000;
            const positions = new Float32Array(particles * 3);
            const colors = new Float32Array(particles * 3);

            const color1 = new THREE.Color(0x6a00ff); // fyre-primary
            const color2 = new THREE.Color(0xff00aa); // fyre-secondary

            for (let i = 0; i < positions.length; i += 3) {
                positions[i] = (Math.random() - 0.5) * 10;
                positions[i + 1] = (Math.random() - 0.5) * 10;
                positions[i + 2] = (Math.random() - 0.5) * 10;

                const mixedColor = color1.clone().lerp(color2, Math.random());
                colors[i] = mixedColor.r;
                colors[i + 1] = mixedColor.g;
                colors[i + 2] = mixedColor.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.02,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            const particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);

            camera.position.z = 5;

            let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            });

            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });

            function animate() {
                requestAnimationFrame(animate);

                // Smoother camera parallax effect
                camera.position.x += (mouseX * 0.1 - camera.position.x) * 0.02;
                camera.position.y += (mouseY * 0.1 - camera.position.y) * 0.02;
                camera.lookAt(scene.position);

                particleSystem.rotation.y += 0.0005;
                particleSystem.rotation.x += 0.0002;

                renderer.render(scene, camera);
            }
            animate();
        }

        // --- Entry Point ---
        document.addEventListener('DOMContentLoaded', () => {
            initBackground();

            if (authToken) {
                // If token exists, try to start the app
                // We'll verify the token and get ban status via the websocket 'initial_data'
                startApp();
            } else {
                // If no token, show login modal
                document.getElementById('auth-modal').style.display = 'flex';
                document.getElementById('auth-modal').children[0].classList.add('animate-fade-in-up');
            }
        });

    </script>
</body>
</html>
